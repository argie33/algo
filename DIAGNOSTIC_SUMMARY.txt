================================================================================
                        DIAGNOSTIC SUMMARY
                            2026-01-29
================================================================================

FULL DIAGNOSTIC COMPLETE - ALL LOADERS CHECKED

Report Files Generated:
  - /home/stocks/algo/DIAGNOSTIC_REPORT.md (Comprehensive analysis)
  - /home/stocks/algo/DETAILED_ERRORS.txt (All error evidence)
  - /home/stocks/algo/DIAGNOSTIC_SUMMARY.txt (This file)

================================================================================
                        QUICK FACTS
================================================================================

Total Loaders Analyzed: 50+
Loaders Failing: 2 (CONFIRMED)
Loaders Likely Failing: 8
All Loaders Affected: 10+ total

Critical Issues Found: 2
High Priority Issues: 1  
Medium Priority Issues: 1
Low Priority Issues: 1

Time to Fix (estimated): 2-3 hours
Effort Level: Moderate (mostly configuration, one Docker rebuild)

================================================================================
                        CONFIRMED FAILURES
================================================================================

1. ECONDATA-LOADER
   Errors:
     - DNS: rds-stocks.c2gujitq3b.us-east-1.rds.amazonaws.com (no longer exists)
     - IAM: Cannot access Secrets Manager
     - API: FRED_API_KEY not set
   CloudWatch: /ecs/econdata-loader (timestamp: 2026-01-29 13:03:47)
   Fix: Update DB_HOST to stocks.cojggi2mkthi.us-east-1.rds.amazonaws.com

2. PRICEDAILY-LOADER  
   Errors:
     - DNS: rds-stocks.c2gujitq3b.us-east-1.rds.amazonaws.com (no longer exists)
   CloudWatch: /ecs/pricedaily-loader (timestamp: 2026-01-28 02:59:10)
   Fix: Update DB_HOST to stocks.cojggi2mkthi.us-east-1.rds.amazonaws.com

================================================================================
                        LIKELY FAILURES (Same Issue)
================================================================================

Same DNS Issue (Old RDS Endpoint):
  - aaiidata-loader (versions 25-52)
  - annualbalancesheet-loader (version 25)
  - annualcashflow-loader (version 27)

Missing lib Directory in Docker:
  - buysell_etf_weekly-loader
  - buysell_etf_monthly-loader
  - ttmincomestatement-loader

Missing Python Packages:
  - feargreed-loader (missing pyppeteer)
  - buysell_etf_daily-loader (missing dotenv)

================================================================================
                        ISSUE BREAKDOWN
================================================================================

ISSUE #1: DATABASE ENDPOINT MISMATCH (5 loaders)
Location: ECS Task Definitions
Problem: Using old RDS endpoint that no longer exists
Error: psycopg2.OperationalError: could not translate host name
Impact: Tasks fail on startup
Fix Difficulty: EASY (1-2 minutes per loader)
Total Fix Time: 10 minutes

ISSUE #2: MISSING DOCKER FILES (3 loaders)
Location: Dockerfile.ttmincomestatement, Dockerfile.buysell_etf_weekly, Dockerfile.buysell_etf_monthly
Problem: lib directory not copied to Docker image
Error: ModuleNotFoundError: No module named 'lib'
Impact: Tasks fail on startup
Fix Difficulty: EASY (add one COPY line per Dockerfile)
Total Fix Time: 5 minutes + 30 minutes build time

ISSUE #3: MISSING PYTHON PACKAGES (2 loaders)
Location: Docker images
Problem: pyppeteer and dotenv not in pip install list
Error: ModuleNotFoundError
Impact: Tasks fail on startup
Fix Difficulty: EASY (add to pip install)
Total Fix Time: 5 minutes + 30 minutes build time

ISSUE #4: IAM PERMISSIONS (All loaders)
Location: ECS Execution Role
Problem: Role lacks secretsmanager:GetSecretValue permission
Error: AccessDeniedException
Impact: Tasks work but fall back to environment variables
Fix Difficulty: MEDIUM (need AWS IAM access)
Total Fix Time: 5 minutes

ISSUE #5: MISSING API KEY (1 loader)
Location: Task definition environment
Problem: FRED_API_KEY not set
Error: Warning message (non-fatal)
Impact: Uses fallback methods only
Fix Difficulty: EASY (add env var)
Total Fix Time: 2 minutes

================================================================================
                        ACTUAL ERROR MESSAGES
================================================================================

ERROR #1: DNS RESOLUTION
  psycopg2.OperationalError: could not translate host name 
  "rds-stocks.c2gujitq3b.us-east-1.rds.amazonaws.com" to address: 
  Name or service not known

ERROR #2: IAM PERMISSION
  AccessDeniedException: User is not authorized to perform: 
  secretsmanager:GetSecretValue

ERROR #3: MISSING MODULE (LIB)
  ModuleNotFoundError: No module named 'lib'

ERROR #4: MISSING MODULE (DOTENV)
  ModuleNotFoundError: No module named 'dotenv'

ERROR #5: MISSING MODULE (PYPPETEER)
  ModuleNotFoundError: No module named 'pyppeteer'

ERROR #6: MISSING API KEY
  FRED_API_KEY not set - using fallback calendar methods only

================================================================================
                        CORRECTIVE ACTIONS REQUIRED
================================================================================

ACTION 1: FIX DATABASE ENDPOINTS IN ECS
  ✓ Confirm current RDS endpoint: stocks.cojggi2mkthi.us-east-1.rds.amazonaws.com
  ✓ Update task definitions:
      - aaiidata-loader (all versions)
      - annualbalancesheet-loader
      - annualcashflow-loader
      - pricedaily-loader
      - econdata-loader
  ✓ Change DB_HOST from: rds-stocks.c2gujitq3b.us-east-1.rds.amazonaws.com
  ✓ Change DB_HOST to: stocks.cojggi2mkthi.us-east-1.rds.amazonaws.com
  ✓ Verify in CloudWatch logs (no DNS errors)

ACTION 2: FIX MISSING DOCKER DIRECTORIES
  ✓ Edit /home/stocks/algo/Dockerfile.ttmincomestatement
      Add: COPY lib lib
      Before: COPY loadttmincomestatement.py .
  
  ✓ Edit /home/stocks/algo/Dockerfile.buysell_etf_weekly
      Add: COPY lib lib
      Before: COPY loadbuysell_etf_weekly.py .
  
  ✓ Edit /home/stocks/algo/Dockerfile.buysell_etf_monthly
      Add: COPY lib lib
      Before: COPY loadbuysell_etf_monthly.py .
  
  ✓ Rebuild and push Docker images to ECR
  ✓ Update task definitions with new image tags
  ✓ Verify in CloudWatch logs (no ModuleNotFoundError)

ACTION 3: FIX MISSING PYTHON PACKAGES
  ✓ Check if feargreed and buysell_etf_daily Dockerfiles need rebuild
  ✓ Rebuild and push if needed
  ✓ Verify packages in logs

ACTION 4: ADD IAM PERMISSIONS
  ✓ Open AWS Console
  ✓ Go to IAM > Roles
  ✓ Find: stocks-ecs-tasks-stack-ECSExecutionRole-UGhDyOJzoKpz
  ✓ Add inline policy with secretsmanager:GetSecretValue
  ✓ Verify in CloudWatch logs (no AccessDeniedException)

ACTION 5: ADD MISSING API KEYS
  ✓ Add FRED_API_KEY environment variable to econdata-loader
  ✓ Obtain key from FRED website if needed
  ✓ Update task definition

================================================================================
                        RDS ENDPOINT REFERENCE
================================================================================

Old Endpoint (BROKEN):
  rds-stocks.c2gujitq3b.us-east-1.rds.amazonaws.com
  Status: NO LONGER EXISTS
  Error: DNS cannot resolve

New Endpoint (CORRECT):
  stocks.cojggi2mkthi.us-east-1.rds.amazonaws.com
  Status: ACTIVE & AVAILABLE
  Port: 5432
  Database: stocks

================================================================================
                        AFFECTED SERVICES
================================================================================

Financial Data Loading:
  - Economic data (econdata-loader) - FAILING
  - Price data (pricedaily-loader) - FAILING
  - AAII data (aaiidata-loader) - LIKELY FAILING
  - Balance sheet (annualbalancesheet-loader) - LIKELY FAILING
  - Cash flow (annualcashflow-loader) - LIKELY FAILING

Sentiment/Technical:
  - Fear/Greed (feargreed-loader) - FAILING
  - Buy/Sell signals (buysell_etf_daily-loader) - FAILING
  - Buy/Sell weekly (buysell_etf_weekly-loader) - LIKELY FAILING
  - Buy/Sell monthly (buysell_etf_monthly-loader) - LIKELY FAILING

Financial Statements:
  - TTM Income (ttmincomestatement-loader) - LIKELY FAILING

Working Services:
  - Analyst sentiment (analystsentiment-loader) - OK
  - Analyst ratings (analystupgradedowngrade-loader) - OK
  - Other newer loaders - OK

================================================================================
                        NEXT STEPS
================================================================================

1. IMMEDIATE (Now):
   [ ] Review this diagnostic report
   [ ] Confirm RDS endpoint
   [ ] Identify which loaders are actually critical

2. SHORT TERM (Next 30 minutes):
   [ ] Fix ECS task definitions with correct RDS endpoint
   [ ] Update Dockerfiles with COPY lib lib
   [ ] Add IAM policy for Secrets Manager

3. MEDIUM TERM (Next 1-2 hours):
   [ ] Rebuild Docker images
   [ ] Push updated images to ECR
   [ ] Restart loader tasks
   [ ] Verify CloudWatch logs for errors
   [ ] Confirm data is loading successfully

4. LONG TERM:
   [ ] Set up monitoring for loader failures
   [ ] Create automated tests for loader health
   [ ] Document current configuration
   [ ] Plan for infrastructure as code improvements

================================================================================
                        MONITORING
================================================================================

CloudWatch Log Groups to Monitor:
  /ecs/econdata-loader
  /ecs/pricedaily-loader
  /ecs/feargreeddata-loader
  /ecs/buysell_etf_daily-loader
  /ecs/buysell_etf_weekly-loader
  /ecs/buysell_etf_monthly-loader
  /ecs/ttmincomestatement-loader
  /ecs/aaiidata-loader

Search for these errors post-fix:
  "DNS" or "Name or service not known" - Should be GONE
  "AccessDeniedException" - Should be GONE
  "ModuleNotFoundError" - Should be GONE
  Task exit code 0 - Indicates success

================================================================================
                        DOCUMENTATION
================================================================================

All diagnostic information has been saved to:
  /home/stocks/algo/DIAGNOSTIC_REPORT.md
  /home/stocks/algo/DETAILED_ERRORS.txt
  /home/stocks/algo/DIAGNOSTIC_SUMMARY.txt

These files contain:
  - Full error traces
  - RDS configuration details
  - Security group rules
  - Task definition environment variables
  - Affected loader lists
  - Step-by-step fix instructions
  - Verification checklists

================================================================================

END OF DIAGNOSTIC REPORT

