name: deploy-app-stocks

# This workflow has been split into modular components for better maintainability.
# Original workflow has been backed up to deploy-app-stocks.yml.backup
#
# New workflow structure:
# 1. deploy-infrastructure.yml - Handles CloudFormation deployments
# 2. orchestrate-data-loading.yml - Handles all data loading tasks using matrix strategy
# 3. run-single-task.yml - For manual single task execution
#
# This workflow now serves as a coordinator that triggers the appropriate workflows

on:
  workflow_dispatch:
  push:
    branches:
      - '*'
  pull_request:
    branches:
      - '*'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  AWS_ROLE_ARN: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsDeployRole
  AWS_ROLE_SESSION: github-deploy

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
      data-loading: ${{ steps.filter.outputs.data-loading }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            infrastructure:
              - 'cloudformation/**'
              - '.github/workflows/deploy-infrastructure.yml'
            data-loading:
              - 'scripts/**'
              - 'requirements.txt'
              - '.github/workflows/orchestrate-data-loading.yml'

  trigger-infrastructure:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.infrastructure == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger infrastructure deployment
        run: |
          echo "Infrastructure changes detected. Triggering deploy-infrastructure workflow..."
          # The deploy-infrastructure.yml workflow will be triggered automatically
          # by its own path-based triggers

  trigger-data-loading:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.data-loading == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Trigger data loading orchestration
        run: |
          echo "Data loading changes detected. Triggering orchestrate-data-loading workflow..."
          # The orchestrate-data-loading.yml workflow will be triggered automatically
          # by its own path-based triggers

  summary:
    needs: [detect-changes, trigger-infrastructure, trigger-data-loading]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment summary
        run: |
          echo "## Deployment Summary"
          echo "Infrastructure changes: ${{ needs.detect-changes.outputs.infrastructure }}"
          echo "Data loading changes: ${{ needs.detect-changes.outputs.data-loading }}"
          echo ""
          echo "The deployment has been split into modular workflows:"
          echo "- Infrastructure: deploy-infrastructure.yml"
          echo "- Data Loading: orchestrate-data-loading.yml"
          echo "- Manual Tasks: run-single-task.yml"
          echo ""
          echo "Check the Actions tab for the specific workflow runs."