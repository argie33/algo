name: deploy-app-stocks

permissions:
  id-token: write
  contents: read

on:
  push:
    branches:
      - "**"

env:
  AWS_REGION:       us-east-1
  AWS_ROLE_ARN:     arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsDeployRole
  AWS_ROLE_SESSION: github-deploy
  FRED_API_KEY:     ${{ secrets.FRED_API_KEY }}

jobs:
  ##########################################
  # 0) Filter — detect exactly what changed #
  ##########################################
  filter:
    runs-on: ubuntu-latest
    outputs:
      symbols:        ${{ steps.f.outputs.symbols }}
      econ:           ${{ steps.f.outputs.econ }}
      findata:        ${{ steps.f.outputs.findata }}
      pricedaily:     ${{ steps.f.outputs.pricedaily }}
      priceweekly:    ${{ steps.f.outputs.priceweekly }}
      pricemonthly:   ${{ steps.f.outputs.pricemonthly }}
      technicaldaily: ${{ steps.f.outputs.technicaldaily }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - id: f
        name: Detect which parts changed
        uses: dorny/paths-filter@v2
        with:
          base: ${{ github.event.before }}
          filters: |
            symbols:
              - 'loadstocksymbols.py'
              - 'requirements-loadstocksymbols.txt'
              - 'Dockerfile.stocksymbols'
            econ:
              - 'loadecondata.py'
              - 'requirements-loadecondata.txt'
              - 'Dockerfile.econdata'
            findata:
              - 'loadfinancialdata.py'
              - 'requirements-loadfinancialdata.txt'
              - 'Dockerfile.findata'
            pricedaily:
              - 'loadpricedaily.py'
              - 'requirements-loadpricedaily.txt'
              - 'Dockerfile.pricedaily'
            priceweekly:
              - 'loadpriceweekly.py'
              - 'requirements-loadpriceweekly.txt'
              - 'Dockerfile.priceweekly'
            pricemonthly:
              - 'loadpricemonthly.py'
              - 'requirements-loadpricemonthly.txt'
              - 'Dockerfile.pricemonthly'
            technicaldaily:
              - 'loadtechnicalsdaily.py'
              - 'requirements-loadtechnicalsdaily.txt'
              - 'Dockerfile.technicalsdaily'

################################################################################
# Reusable snippet — insert these two steps before every `deploy` step below:   #
#                                                                              #
#   - Fetch existing ECS stack params (if any)                                 #
#   - Guard & delete ROLLBACK_COMPLETE stack                                    #
################################################################################

  ####################################################
  # 1a) stock-symbols ECS: build → deploy → run      #
  ####################################################
  symbols:
    needs: filter
    if: ${{ needs.filter.outputs.symbols == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Configure AWS creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region:        ${{ env.AWS_REGION }}
          role-to-assume:    ${{ env.AWS_ROLE_ARN }}
          role-session-name: ${{ env.AWS_ROLE_SESSION }}

      - name: Build & push stock-symbols image
        id: image
        run: |
          REPO=stocks-app-registry
          aws ecr describe-repositories --repository-names "$REPO" \
            >/dev/null 2>&1 || aws ecr create-repository --repository-name "$REPO"
          URI=$(aws ecr describe-repositories \
            --repository-names "$REPO" \
            --query 'repositories[0].repositoryUri' --output text)
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin "$URI"
          TAG=stocksymbols-${{ github.sha }}
          IMG="${URI}:$TAG"
          docker build -f Dockerfile.stocksymbols -t "$IMG" .
          docker push "$IMG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Fetch existing ECS stack params (if any)
        id: params
        run: |
          if aws cloudformation describe-stacks --stack-name stocks-ecs-tasks-stack \
               >/dev/null 2>&1; then
            for key in FindataImageTag PriceImageTag PriceWeeklyImageTag PriceMonthlyImageTag TechnicalDailyImageTag StockSymbolsImageTag EconDataImageTag MonthlyPriceImageTag; do
              val=$(aws cloudformation describe-stacks \
                      --stack-name stocks-ecs-tasks-stack \
                      --query "Stacks[0].Parameters[?ParameterKey=='${key}'].ParameterValue" \
                      --output text)
              echo "${key,,}=$val" >> $GITHUB_OUTPUT
            done
          else
            echo "Stack not found, skipping parameter fetch"
          fi

      - name: Guard & delete ROLLBACK_COMPLETE stack
        run: |
          if STATUS=$(aws cloudformation describe-stacks \
                         --stack-name stocks-ecs-tasks-stack \
                         --query "Stacks[0].StackStatus" --output text 2>/dev/null); then
            if [ "$STATUS" = "ROLLBACK_COMPLETE" ]; then
              aws cloudformation delete-stack --stack-name stocks-ecs-tasks-stack
              aws cloudformation wait stack-delete-complete --stack-name stocks-ecs-tasks-stack
            fi
          fi

      - name: Deploy ECS CFN (stock-symbols)
        run: |
          aws cloudformation deploy \
            --stack-name stocks-ecs-tasks-stack \
            --template-file template-app-ecs-tasks.yml \
            --parameter-overrides \
              FindataImageTag=${{ steps.params.outputs.findataimagetag }} \
              PriceImageTag=${{ steps.params.outputs.priceimagetag }} \
              PriceWeeklyImageTag=${{ steps.params.outputs.priceweeklyimagetag }} \
              PriceMonthlyImageTag=${{ steps.params.outputs.pricemonthlyimagetag }} \
              TechnicalDailyImageTag=${{ steps.params.outputs.technicaldailyimagetag }} \
              StockSymbolsImageTag=${{ steps.image.outputs.tag }} \
              EconDataImageTag=${{ steps.params.outputs.econdataimagetag }} \
              MonthlyPriceImageTag=${{ steps.params.outputs.monthlypriceimagetag }} \
              FREDApiKey=$FRED_API_KEY \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset

      - name: Run stock-symbols loader
        run: |
          SVC=$(aws cloudformation describe-stacks \
            --stack-name stocks-ecs-tasks-stack \
            --query "Stacks[0].Outputs[?OutputKey=='StockSymbolsServiceName'].OutputValue" \
            --output text)
          aws ecs update-service --cluster stocks-cluster --service "$SVC" --desired-count 1
          aws ecs wait services-stable --cluster stocks-cluster --services "$SVC"
          aws ecs update-service --cluster stocks-cluster --service "$SVC" --desired-count 0

  ####################################################
  # 1b) econ-data ECS: build → deploy → run          #
  ####################################################
  econ:
    needs: filter
    if: ${{ needs.filter.outputs.econ == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Configure AWS creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region:        ${{ env.AWS_REGION }}
          role-to-assume:    ${{ env.AWS_ROLE_ARN }}
          role-session-name: ${{ env.AWS_ROLE_SESSION }}

      - name: Build & push econ-data image
        id: image
        run: |
          REPO=stocks-app-registry
          aws ecr describe-repositories --repository-names "$REPO" \
            >/dev/null 2>&1 || aws ecr create-repository --repository-name "$REPO"
          URI=$(aws ecr describe-repositories \
            --repository-names "$REPO" \
            --query 'repositories[0].repositoryUri' --output text)
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin "$URI"
          TAG=econdata-${{ github.sha }}
          IMG="${URI}:$TAG"
          docker build -f Dockerfile.econdata -t "$IMG" .
          docker push "$IMG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Fetch existing ECS stack params (if any)
        id: params
        run: |
          if aws cloudformation describe-stacks --stack-name stocks-ecs-tasks-stack \
               >/dev/null 2>&1; then
            for key in FindataImageTag PriceImageTag PriceWeeklyImageTag PriceMonthlyImageTag TechnicalDailyImageTag StockSymbolsImageTag EconDataImageTag MonthlyPriceImageTag; do
              val=$(aws cloudformation describe-stacks \
                      --stack-name stocks-ecs-tasks-stack \
                      --query "Stacks[0].Parameters[?ParameterKey=='${key}'].ParameterValue" \
                      --output text)
              echo "${key,,}=$val" >> $GITHUB_OUTPUT
            done
          fi

      - name: Guard & delete ROLLBACK_COMPLETE stack
        run: |
          if STATUS=$(aws cloudformation describe-stacks \
                         --stack-name stocks-ecs-tasks-stack \
                         --query "Stacks[0].StackStatus" --output text 2>/dev/null); then
            if [ "$STATUS" = "ROLLBACK_COMPLETE" ]; then
              aws cloudformation delete-stack --stack-name stocks-ecs-tasks-stack
              aws cloudformation wait stack-delete-complete --stack-name stocks-ecs-tasks-stack
            fi
          fi

      - name: Deploy ECS CFN (econ-data)
        run: |
          aws cloudformation deploy \
            --stack-name stocks-ecs-tasks-stack \
            --template-file template-app-ecs-tasks.yml \
            --parameter-overrides \
              FindataImageTag=${{ steps.params.outputs.findataimagetag }} \
              PriceImageTag=${{ steps.params.outputs.priceimagetag }} \
              PriceWeeklyImageTag=${{ steps.params.outputs.priceweeklyimagetag }} \
              PriceMonthlyImageTag=${{ steps.params.outputs.pricemonthlyimagetag }} \
              TechnicalDailyImageTag=${{ steps.params.outputs.technicaldailyimagetag }} \
              StockSymbolsImageTag=${{ steps.params.outputs.stocksymbolsimagetag }} \
              EconDataImageTag=${{ steps.image.outputs.tag }} \
              MonthlyPriceImageTag=${{ steps.params.outputs.monthlypriceimagetag }} \
              FREDApiKey=$FRED_API_KEY \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset

      - name: Run econ-data loader
        run: |
          SVC=$(aws cloudformation.describe-stacks \
            --stack-name stocks-ecs-tasks-stack \
            --query "Stacks[0].Outputs[?OutputKey=='EconDataServiceName'].OutputValue" \
            --output text)
          aws ecs update-service --cluster stocks-cluster --service "$SVC" --desired-count 1
          aws ecs wait services-stable --cluster stocks-cluster --services "$SVC"
          aws ecs update-service --cluster stocks-cluster --service "$SVC" --desired-count 0

  ####################################################
  # 2a) findata ECS: build → deploy → run           #
  ####################################################
  findata:
    needs: filter
    if: ${{ needs.filter.outputs.findata == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Configure AWS creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region:        ${{ env.AWS_REGION }}
          role-to-assume:    ${{ env.AWS_ROLE_ARN }}
          role-session-name: ${{ env.AWS_ROLE_SESSION }}

      - name: Build & push findata image
        id: image
        run: |
          REPO=stocks-app-registry
          aws ecr describe-repositories --repository-names "$REPO" \
            >/dev/null 2>&1 || aws ecr create-repository --repository-name "$REPO"
          URI=$(aws ecr.describe-repositories \
            --repository-names "$REPO" \
            --query 'repositories[0].repositoryUri' --output text)
          aws ecr get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin "$URI"
          TAG=findata-${{ github.sha }}
          IMG="${URI}:$TAG"
          docker build -f Dockerfile.findata -t "$IMG" .
          docker push "$IMG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Fetch existing ECS stack params (if any)
        id: params
        run: |
          if aws cloudformation describe-stacks --stack-name stocks-ecs-tasks-stack \
               >/dev/null 2>&1; then
            for key in PriceImageTag PriceWeeklyImageTag PriceMonthlyImageTag TechnicalDailyImageTag StockSymbolsImageTag EconDataImageTag MonthlyPriceImageTag; do
              val=$(aws cloudformation describe-stacks \
                      --stack-name stocks-ecs-tasks-stack \
                      --query "Stacks[0].Parameters[?ParameterKey=='${key}'].ParameterValue" \
                      --output text)
              echo "${key,,}=$val" >> $GITHUB_OUTPUT
            done
          fi

      - name: Guard & delete ROLLBACK_COMPLETE stack
        run: |
          if STATUS=$(aws cloudformation describe-stacks \
                         --stack-name stocks-ecs-tasks-stack \
                         --query "Stacks[0].StackStatus" --output text 2>/dev/null); then
            if [ "$STATUS" = "ROLLBACK_COMPLETE" ]; then
              aws cloudformation.delete-stack --stack-name stocks-ecs-tasks-stack
              aws cloudformation.wait stack-delete-complete --stack-name stocks-ecs-tasks-stack
            fi
          fi

      - name: Deploy ECS CFN (findata)
        run: |
          aws cloudformation deploy \
            --stack-name stocks-ecs-tasks-stack \
            --template-file template-app-ecs-tasks.yml \
            --parameter-overrides \
              FindataImageTag=${{ steps.image.outputs.tag }} \
              PriceImageTag=${{ steps.params.outputs.priceimagetag }} \
              PriceWeeklyImageTag=${{ steps.params.outputs.priceweeklyimagetag }} \
              PriceMonthlyImageTag=${{ steps.params.outputs.pricemonthlyimagetag }} \
              TechnicalDailyImageTag=${{ steps.params.outputs.technicaldailyimagetag }} \
              StockSymbolsImageTag=${{ steps.params.outputs.stocksymbolsimatetag }} \
              EconDataImageTag=${{ steps.params.outputs.econdataimagetag }} \
              MonthlyPriceImageTag=${{ steps.params.outputs.monthlypriceimagetag }} \
              FREDApiKey=$FRED_API_KEY \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset

      - name: Run findata loader
        run: |
          SVC=$(aws cloudformation.describe-stacks \
            --stack-name stocks-ecs-tasks-stack \
            --query "Stacks[0].Outputs[?OutputKey=='FindataLoaderServiceName'].OutputValue" \
            --output text)
          aws ecs update-service --cluster stocks-cluster --service "$SVC" --desired-count 1
          aws ecs wait services-stable --cluster stocks-cluster --services "$SVC"
          aws ecs update-service --cluster stocks-cluster --service "$SVC" --desired-count 0

  ####################################################
  # 2b) pricedaily ECS: build → deploy → run         #
  ####################################################
  pricedaily:
    needs: filter
    if: ${{ needs.filter.outputs.pricedaily == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Configure AWS creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region:        ${{ env.AWS_REGION }}
          role-to-assume:    ${{ env.AWS_ROLE_ARN }}
          role-session-name: ${{ env.AWS_ROLE_SESSION }}

      - name: Build & push pricedaily image
        id: image
        run: |
          REPO=stocks-app-registry
          aws ecr.describe-repositories --repository-names "$REPO" \
            >/dev/null 2>&1 || aws ecr.create-repository --repository-name "$REPO"
          URI=$(aws ecr.describe-repositories \
            --repository-names "$REPO" \
            --query 'repositories[0].repositoryUri' --output text)
          aws ecr.get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin "$URI"
          TAG=pricedaily-${{ github.sha }}
          IMG="${URI}:$TAG"
          docker build -f Dockerfile.pricedaily -t "$IMG" .
          docker push "$IMG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Fetch existing ECS stack params (if any)
        id: params
        run: |
          if aws.cloudformation.describe-stacks --stack-name stocks-ecs-tasks-stack \
               >/dev/null 2>&1; then
            for key in FindataImageTag PriceImageTag PriceWeeklyImageTag PriceMonthlyImageTag TechnicalDailyImageTag StockSymbolsImageTag EconDataImageTag MonthlyPriceImageTag; do
              val=$(aws.cloudformation.describe-stacks \
                      --stack-name stocks-ecs-tasks-stack \
                      --query "Stacks[0].Parameters[?ParameterKey=='${key}'].ParameterValue" \
                      --output text)
              echo "${key,,}=$val" >> $GITHUB_OUTPUT
            done
          fi

      - name: Guard & delete ROLLBACK_COMPLETE stack
        run: |
          if STATUS=$(aws cloudformation.describe-stacks \
                         --stack-name stocks-ecs-tasks-stack \
                         --query "Stacks[0].StackStatus" --output text 2>/dev/null); then
            if [ "$STATUS" = "ROLLBACK_COMPLETE" ]; then
              aws cloudformation.delete-stack --stack-name stocks-ecs-tasks-stack
              aws cloudformation.wait stack-delete-complete --stack-name stocks-ecs-tasks-stack
            fi
          fi

      - name: Deploy ECS CFN (pricedaily)
        run: |
          aws cloudformation deploy \
            --stack-name stocks-ecs-tasks-stack \
            --template-file template-app-ecs-tasks.yml \
            --parameter-overrides \
              FindataImageTag=${{ steps.params.outputs.findataimagetag }} \
              PriceImageTag=${{ steps.image.outputs.tag }} \
              PriceWeeklyImageTag=${{ steps.params.outputs.priceweeklyimagetag }} \
              PriceMonthlyImageTag=${{ steps.params.outputs.pricemonthlyimagetag }} \
              TechnicalDailyImageTag=${{ steps.params.outputs.technicaldailyimagetag }} \
              StockSymbolsImageTag=${{ steps.params.outputs.stocksymbolsimatetag }} \
              EconDataImageTag=${{ steps.params.outputs.econdataimagetag }} \
              MonthlyPriceImageTag=${{ steps.params.outputs.monthlypriceimagetag }} \
              FREDApiKey=$FRED_API_KEY \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset

      - name: Run pricedaily loader
        run: |
          SVC=$(aws.cloudformation.describe-stacks \
            --stack-name stocks-ecs-tasks-stack \
            --query "Stacks[0].Outputs[?OutputKey=='PriceDailyLoaderServiceName'].OutputValue" \
            --output text)
          aws ecs update-service --cluster stocks-cluster --service "$SVC" --desired-count 1
          aws ecs.wait services-stable --cluster stocks-cluster --services "$SVC"
          aws ecs.update-service --cluster stocks-cluster --service "$SVC" --desired-count 0

  ####################################################
  # 2c) priceweekly ECS: build → deploy → run        #
  ####################################################
  priceweekly:
    needs: filter
    if: ${{ needs.filter.outputs.priceweekly == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Configure AWS creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region:        ${{ env.AWS_REGION }}
          role-to-assume:    ${{ env.AWS_ROLE_ARN }}
          role-session-name: ${{ env.AWS_ROLE_SESSION }}

      - name: Build & push priceweekly image
        id: image
        run: |
          REPO=stocks-app-registry
          aws.cloudformation.describe-repositories --repository-names "$REPO" \
            >/dev/null 2>&1 || aws.cloudformation.create-repository --repository-name "$REPO"
          URI=$(aws.cloudformation.describe-repositories \
            --repository-names "$REPO" \
            --query 'repositories[0].repositoryUri' --output text)
          aws.cloudformation.get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin "$URI"
          TAG=priceweekly-${{ github.sha }}
          IMG="${URI}:$TAG"
          docker build -f Dockerfile.priceweekly -t "$IMG" .
          docker push "$IMG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Fetch existing ECS stack params (if any)
        id: params
        run: |
          if aws.cloudformation.describe-stacks --stack-name stocks-ecs-tasks-stack \
               >/dev/null 2>&1; then
            for key in FindataImageTag PriceImageTag PriceWeeklyImageTag PriceMonthlyImageTag TechnicalDailyImageTag StockSymbolsImageTag EconDataImageTag MonthlyPriceImageTag; do
              val=$(aws.cloudformation.describe-stacks \
                      --stack-name stocks-ecs-tasks-stack \
                      --query "Stacks[0].Parameters[?ParameterKey=='${key}'].ParameterValue" \
                      --output text)
              echo "${key,,}=$val" >> $GITHUB_OUTPUT
            done
          fi

      - name: Guard & delete ROLLBACK_COMPLETE stack
        run: |
          if STATUS=$(aws.cloudformation.describe-stacks \
                         --stack-name stocks-ecs-tasks-stack \
                         --query "Stacks[0].StackStatus" --output text 2>/dev/null); then
            if [ "$STATUS" = "ROLLBACK_COMPLETE" ]; then
              aws.cloudformation.delete-stack --stack-name stocks-ecs-tasks-stack
              aws.cloudformation.wait stack-delete-complete --stack-name stocks-ecs-tasks-stack
            fi
          fi

      - name: Deploy ECS CFN (priceweekly)
        run: |
          aws.cloudformation deploy \
            --stack-name stocks-ecs-tasks-stack \
            --template-file template-app-ecs-tasks.yml \
            --parameter-overrides \
              FindataImageTag=${{ steps.params.outputs.findataimagetag }} \
              PriceImageTag=${{ steps.params.outputs.priceimagetag }} \
              PriceWeeklyImageTag=${{ steps.image.outputs.tag }} \
              PriceMonthlyImageTag=${{ steps.params.outputs.pricemonthlyimagetag }} \
              TechnicalDailyImageTag=${{ steps.params.outputs.technicaldailyimagetag }} \
              StockSymbolsImageTag=${{ steps.params.outputs.stocksymbolsimatetag }} \
              EconDataImageTag=${{ steps.params.outputs.econdataimagetag }} \
              MonthlyPriceImageTag=${{ steps.params.outputs.monthlypriceimagetag }} \
              FREDApiKey=$FRED_API_KEY \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset

      - name: Run priceweekly loader
        run: |
          SVC=$(aws.cloudformation.describe-stacks \
            --stack-name stocks-ecs-tasks-stack \
            --query "Stacks[0].Outputs[?OutputKey=='PriceWeeklyLoaderServiceName'].OutputValue" \
            --output text)
          aws ecs update-service --cluster stocks-cluster --service "$SVC" --desired-count 1
          aws ecs.wait services-stable --cluster stocks-cluster --services "$SVC"
          aws ecs.update-service --cluster stocks-cluster --service "$SVC" --desired-count 0

  ####################################################
  # 2d) pricemonthly ECS: build → deploy → run       #
  ####################################################
  pricemonthly:
    needs: filter
    if: ${{ needs.filter.outputs.pricemonthly == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Configure AWS creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region:        ${{ env.AWS_REGION }}
          role-to-assume:    ${{ env.AWS_ROLE_ARN }}
          role-session-name: ${{ env.AWS_ROLE_SESSION }}

      - name: Build & push pricemonthly image
        id: image
        run: |
          REPO=stocks-app-registry
          aws.cloudformation.describe-repositories --repository-names "$REPO" \
            >/dev/null 2>&1 || aws.cloudformation.create-repository --repository-name "$REPO"
          URI=$(aws.cloudformation.describe-repositories \
            --repository-names "$REPO" \
            --query 'repositories[0].repositoryUri' --output text)
          aws.cloudformation.get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin "$URI"
          TAG=pricemonthly-${{ github.sha }}
          IMG="${URI}:$TAG"
          docker build -f Dockerfile.pricemonthly -t "$IMG" .
          docker push "$IMG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Fetch existing ECS stack params (if any)
        id: params
        run: |
          if aws.cloudformation.describe-stacks --stack-name stocks-ecs-tasks-stack \
               >/dev/null 2>&1; then
            for key in FindataImageTag PriceImageTag PriceWeeklyImageTag PriceMonthlyImageTag TechnicalDailyImageTag StockSymbolsImageTag EconDataImageTag MonthlyPriceImageTag; do
              val=$(aws.cloudformation.describe-stacks \
                      --stack-name stocks-ecs-tasks-stack \
                      --query "Stacks[0].Parameters[?ParameterKey=='${key}'].ParameterValue" \
                      --output text)
              echo "${key,,}=$val" >> $GITHUB_OUTPUT
            done
          fi

      - name: Guard & delete ROLLBACK_COMPLETE stack
        run: |
          if STATUS=$(aws.cloudformation.describe-stacks \
                         --stack-name stocks-ecs-tasks-stack \
                         --query "Stacks[0].StackStatus" --output text 2>/dev/null); then
            if [ "$STATUS" = "ROLLBACK_COMPLETE" ]; then
              aws.cloudformation.delete-stack --stack-name stocks-ecs-tasks-stack
              aws.cloudformation.wait stack-delete-complete --stack-name stocks-ecs-tasks-stack
            fi
          fi

      - name: Deploy ECS CFN (pricemonthly)
        run: |
          aws.cloudformation.deploy \
            --stack-name stocks-ecs-tasks-stack \
            --template-file template-app-ecs-tasks.yml \
            --parameter-overrides \
              FindataImageTag=${{ steps.params.outputs.findataimagetag }} \
              PriceImageTag=${{ steps.params.outputs.priceimagetag }} \
              PriceWeeklyImageTag=${{ steps.params.outputs.priceweeklyimagetag }} \
              PriceMonthlyImageTag=${{ steps.image.outputs.tag }} \
              TechnicalDailyImageTag=${{ steps.params.outputs.technicaldailyimagetag }} \
              StockSymbolsImageTag=${{ steps.params.outputs.stocksymbolsimatetag }} \
              EconDataImageTag=${{ steps.params.outputs.econdataimagetag }} \
              MonthlyPriceImageTag=${{ steps.params.outputs.monthlypriceimagetag }} \
              FREDApiKey=$FRED_API_KEY \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset

      - name: Run pricemonthly loader
        run: |
          SVC=$(aws.cloudformation.describe-stacks \
            --stack-name stocks-ecs-tasks-stack \
            --query "Stacks[0].Outputs[?OutputKey=='PriceMonthlyLoaderServiceName'].OutputValue" \
            --output text)
          aws ecs.update-service --cluster stocks-cluster --service "$SVC" --desired-count 1
          aws ecs.wait services-stable --cluster stocks-cluster --services "$SVC"
          aws ecs.update-service --cluster stocks-cluster --service "$SVC" --desired-count 0

  ##############################################################
  # 2e) technicaldaily ECS: build → deploy → run              #
  ##############################################################
  technicaldaily:
    needs: filter
    if: ${{ needs.filter.outputs.technicaldaily == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Configure AWS creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region:        ${{ env.AWS_REGION }}
          role-to-assume:    ${{ env.AWS_ROLE_ARN }}
          role-session-name: ${{ env.AWS_ROLE_SESSION }}

      - name: Build & push technicaldaily image
        id: image
        run: |
          REPO=stocks-app-registry
          aws.cloudformation.describe-repositories --repository-names "$REPO" \
            >/dev/null 2>&1 || aws.cloudformation.create-repository --repository-name "$REPO"
          URI=$(aws.cloudformation.describe-repositories \
            --repository-names "$REPO" \
            --query 'repositories[0].repositoryUri' --output text)
          aws.cloudformation.get-login-password --region $AWS_REGION \
            | docker login --username AWS --password-stdin "$URI"
          TAG=technicaldaily-${{ github.sha }}
          IMG="${URI}:$TAG"
          docker build -f Dockerfile.technicalsdaily -t "$IMG" .
          docker push "$IMG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Fetch existing ECS stack params (if any)
        id: params
        run: |
          if aws.cloudformation.describe-stacks --stack-name stocks-ecs-tasks-stack \
               >/dev/null 2>&1; then
            for key in FindataImageTag PriceImageTag PriceWeeklyImageTag PriceMonthlyImageTag TechnicalDailyImageTag StockSymbolsImageTag EconDataImageTag MonthlyPriceImageTag; do
              val=$(aws.cloudformation.describe-stacks \
                      --stack-name stocks-ecs-tasks-stack \
                      --query "Stacks[0].Parameters[?ParameterKey=='${key}'].ParameterValue" \
                      --output text)
              echo "${key,,}=$val" >> $GITHUB_OUTPUT
            done
          fi

      - name: Guard & delete ROLLBACK_COMPLETE stack
        run: |
          if STATUS=$(aws.cloudformation.describe-stacks \
                         --stack-name stocks-ecs-tasks-stack \
                         --query "Stacks[0].StackStatus" --output text 2>/dev/null); then
            if [ "$STATUS" = "ROLLBACK_COMPLETE" ]; then
              aws.cloudformation.delete-stack --stack-name stocks-ecs-tasks-stack
              aws.cloudformation.wait stack-delete-complete --stack-name stocks-ecs-tasks-stack
            fi
          fi

      - name: Deploy ECS CFN (technicaldaily)
        run: |
          aws.cloudformation.deploy \
            --stack-name stocks-ecs-tasks-stack \
            --template-file template-app-ecs-tasks.yml \
            --parameter-overrides \
              FindataImageTag=${{ steps.params.outputs.findataimagetag }} \
              PriceImageTag=${{ steps.params.outputs.priceimagetag }} \
              PriceWeeklyImageTag=${{ steps.params.outputs.priceweeklyimagetag }} \
              PriceMonthlyImageTag=${{ steps.params.outputs.pricemonthlyimagetag }} \
              TechnicalDailyImageTag=${{ steps.image.outputs.tag }} \
              StockSymbolsImageTag=${{ steps.params.outputs.stocksymbolsimatetag }} \
              EconDataImageTag=${{ steps.params.outputs.econdataimagetag }} \
              MonthlyPriceImageTag=${{ steps.params.outputs.monthlypriceimagetag }} \
              FREDApiKey=$FRED_API_KEY \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset

      - name: Run technicaldaily loader
        run: |
          SVC=$(aws.cloudformation.describe-stacks \
            --stack-name stocks-ecs-tasks-stack \
            --query "Stacks[0].Outputs[?OutputKey=='TechnicalDailyLoaderServiceName'].OutputValue" \
            --output text)
          aws ecs.update-service --cluster stocks-cluster --service "$SVC" --desired-count 1
          aws ecs.wait services-stable --cluster stocks-cluster --services "$SVC"
          aws ecs.update-service --cluster stocks-cluster --service "$SVC" --desired-count 0
