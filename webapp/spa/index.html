<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Stocks Dashboard</title>
  <!-- Test deployment - 2025-07-10 - Fixed ARM64 architecture -->
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 8px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Stocks Data - Debug Version</h1>
  <button id="load">Load Data</button>
  <button id="debug">Debug API</button>
  <button id="create-table">Create Table</button>
  <div id="status">Loading...</div>
  <div id="table"></div>

  <script>
    const API = 'PLACEHOLDER_API_URL/api/stocks';  // Fixed path with /api/ prefix
    const API_BASE = 'PLACEHOLDER_API_URL';  // Base URL for debug endpoints

    // Show initial status
    document.getElementById('status').innerHTML = 'Page loaded. Click "Load Data" to test API.';
    
    // Add global error handler
    window.onerror = function(msg, url, line, col, error) {
      console.error('Global error:', msg, 'at', url, ':', line);
      document.getElementById('status').innerHTML = `<span style="color: red;">JavaScript Error: ${msg}</span>`;
      return false;
    };

    // Debug button to test various API endpoints
    document.getElementById('debug').onclick = async () => {
      try {
        document.getElementById('status').innerHTML = 'Running debug tests...';
        
        const tests = [
          { name: 'Root API', url: `${API_BASE}/` },
          { name: 'Health Check', url: `${API_BASE}/health` },
          { name: 'DB Test', url: `${API_BASE}/health/debug/db-test` },
          { name: 'Tables List', url: `${API_BASE}/health/debug/tables` },
          { name: 'Environment', url: `${API_BASE}/health/debug/env` }
        ];
        
        let results = '<h3>Debug Results:</h3>';
        for (const test of tests) {
          try {
            const res = await fetch(test.url, { mode: 'cors' });
            const data = await res.json();
            results += `<div><strong>${test.name}:</strong> ✅ ${res.status} - ${JSON.stringify(data).substring(0, 100)}...</div>`;
          } catch (error) {
            results += `<div><strong>${test.name}:</strong> ❌ ${error.message}</div>`;
          }
        }
        
        document.getElementById('table').innerHTML = results;
        document.getElementById('status').innerHTML = 'Debug tests completed!';
      } catch (error) {
        document.getElementById('status').innerHTML = `Debug failed: ${error.message}`;
      }
    };

    // Create table button
    document.getElementById('create-table').onclick = async () => {
      try {
        document.getElementById('status').innerHTML = 'Creating database table...';
        const res = await fetch(`${API_BASE}/health/create-table`, { method: 'POST', mode: 'cors' });
        const data = await res.json();
        
        if (res.ok) {
          document.getElementById('status').innerHTML = '<span style="color: green;">Table created successfully!</span>';
          document.getElementById('table').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        } else {
          document.getElementById('status').innerHTML = '<span style="color: red;">Table creation failed</span>';
          document.getElementById('table').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (error) {
        document.getElementById('status').innerHTML = `Create table failed: ${error.message}`;
      }
    };

    document.getElementById('load').onclick = async () => {
      try {
        document.getElementById('status').innerHTML = 'Fetching data from API...';
        console.log('Fetching from:', API);
        
        const res = await fetch(API, { mode: 'cors' });
        console.log('Response status:', res.status);
        
        document.getElementById('status').innerHTML = `API responded with status: ${res.status}`;
        
        const data = await res.json();
        console.log('Response data:', data);
        
        if (data.error) {
          document.getElementById('status').innerHTML = `<span style="color: orange;">API Error: ${data.error}</span>`;
          document.getElementById('table').innerHTML = `<p>Error: ${data.details || data.error}</p>`;
          return;
        }
        
        if (!data.length) {
          document.getElementById('status').innerHTML = '<span style="color: blue;">API returned empty data</span>';
          document.getElementById('table').innerHTML = '<p>No data available. Database tables may be missing.</p>';
          return;
        }
        
        document.getElementById('status').innerHTML = '<span style="color: green;">Data loaded successfully!</span>';
      const cols = Object.keys(data[0]);
      let html = '<table><thead><tr>' +
        cols.map(c => `<th>${c}</th>`).join('') +
        '</tr></thead><tbody>';
      data.forEach(row => {
        html += '<tr>' + cols.map(c => `<td>${row[c]}</td>`).join('') + '</tr>';
      });
      html += '</tbody></table>';
      document.getElementById('table').innerHTML = html;
    } catch (error) {
      console.error('API Error:', error);
      document.getElementById('status').innerHTML = `<span style="color: red;">Request failed: ${error.message}</span>`;
      document.getElementById('table').innerHTML = `<p style="color: red;">Error: ${error.message}<br/>Check console for details.</p>`;
    }
    };
  </script>
</body>
</html>
