#!/bin/bash

# Dynamic Frontend Build Script
# This script builds the frontend with the correct API URL from CloudFormation

set -e

STACK_NAME=${1:-"financial-dashboard-dev"}
ENVIRONMENT=${2:-"dev"}

echo "ðŸš€ Building frontend for stack: $STACK_NAME"

# Get API Gateway URL from CloudFormation stack outputs
echo "ðŸ“¡ Fetching API Gateway URL from CloudFormation..."
API_URL=$(aws cloudformation describe-stacks \
  --stack-name "$STACK_NAME" \
  --query 'Stacks[0].Outputs[?OutputKey==`ApiGatewayUrl`].OutputValue' \
  --output text)

if [ -z "$API_URL" ] || [ "$API_URL" = "None" ]; then
  echo "âŒ Failed to get API Gateway URL from stack $STACK_NAME"
  echo "   Available stacks:"
  aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE --query 'StackSummaries[].StackName' --output table
  exit 1
fi

echo "âœ… Found API Gateway URL: $API_URL"

# Create dynamic .env file
echo "ðŸ“ Creating .env file with dynamic API URL..."
cat > .env << EOF
# Auto-generated by deploy script
VITE_API_URL=$API_URL
VITE_SERVERLESS=true
VITE_ENVIRONMENT=$ENVIRONMENT
VITE_BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
VITE_STACK_NAME=$STACK_NAME
EOF

echo "ðŸ“‹ Environment configuration:"
cat .env

# Build the frontend
echo "ðŸ”¨ Building frontend..."
npm run build

echo "âœ… Frontend build complete!"
echo "ðŸ“ Built files are in the 'dist' directory"
echo "ðŸŒ API URL: $API_URL"
