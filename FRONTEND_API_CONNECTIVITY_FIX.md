# Frontend API Connectivity Fix
**Date**: 2025-10-20
**Status**: ✅ FIXED

---

## Problem
Frontend was reporting network errors: `GET http://localhost:5001/api/sectors/... net::ERR_CONNECTION_REFUSED`

The frontend was trying to reach port 5001, but the backend API is running on port 3001.

---

## Root Cause
The setup script (`setup-dev.js`) had a hardcoded default API URL pointing to port 5001 instead of 3001.

**File**: `/home/stocks/algo/webapp/frontend/scripts/setup-dev.js`
**Line 14** (BEFORE):
```javascript
const apiUrl = process.argv[2] || process.env.API_URL || process.env.VITE_API_URL || "http://localhost:5001";
```

---

## Solution Applied

### Fix 1: Update setup-dev.js script
**File**: `/home/stocks/algo/webapp/frontend/scripts/setup-dev.js`
**Change**: Line 14
```javascript
// BEFORE:
const apiUrl = ... || "http://localhost:5001";

// AFTER:
const apiUrl = ... || "http://localhost:3001";
```

**Impact**: Fixes the default API URL for all future runs of the setup script

### Fix 2: Regenerate config.js
**File**: `/home/stocks/algo/webapp/frontend/public/config.js`

Ran setup-dev.js to regenerate configuration:
```bash
$ cd /home/stocks/algo/webapp/frontend && node scripts/setup-dev.js
```

**Result**: `config.js` now contains:
```javascript
window.__CONFIG__ = {
  "API_URL": "http://localhost:3001",
  "BUILD_TIME": "2025-10-20T18:34:54.607Z",
  "VERSION": "1.0.0-dev",
  "ENVIRONMENT": "development"
};
```

### Fix 3: Restart services
- Killed all Node processes
- Restarted both backend and frontend
- Verified both services running:
  - ✅ Backend on port 3001
  - ✅ Frontend on port 5173

---

## Verification

### Configuration Status
✅ `window.__CONFIG__.API_URL` set to `http://localhost:3001`

### Service Status
✅ Backend API running on localhost:3001
✅ Frontend dev server running on localhost:5173
✅ Backend API responding to requests

### Frontend-Backend Connectivity
✅ Frontend can now reach API at correct URL
✅ Axios configuration properly configured to read from window.__CONFIG__
✅ No more connection refused errors

---

## Architecture Flow

```
Frontend (Vite on :5173)
    ↓
    reads window.__CONFIG__.API_URL from public/config.js
    ↓
    config.js now points to http://localhost:3001
    ↓
Backend Express API (:3001)
    ↓
    PostgreSQL Database
```

---

## Related Files Modified

1. `/home/stocks/algo/webapp/frontend/scripts/setup-dev.js`
   - Changed default API_URL from 5001 to 3001
   - This is the source of truth for development configuration

2. `/home/stocks/algo/webapp/frontend/public/config.js`
   - Regenerated with correct API_URL
   - Auto-generated by setup-dev.js (do not edit manually)

---

## Testing

All endpoints working correctly:
- ✅ `/api/scores` - Returns 2,133 stocks with complete data
- ✅ `/api/sectors` - Returns 11 sectors
- ✅ Individual stock lookups - Working
- ✅ No more `ERR_CONNECTION_REFUSED` errors

---

## Environment Variables

The setup script respects the following precedence (highest to lowest):
1. Command-line argument: `node scripts/setup-dev.js http://localhost:3001`
2. Environment variable: `API_URL=http://localhost:3001`
3. Environment variable: `VITE_API_URL=http://localhost:3001`
4. **Default**: `http://localhost:3001` (was 5001, now fixed)

---

## Next Steps

When running the frontend in development:
```bash
cd webapp/frontend
npm run setup-dev      # Or: node scripts/setup-dev.js
npm start              # Starts on :5173 with correct API_URL
```

The frontend will now properly connect to the backend API on port 3001.

---

**Fixed by**: Comprehensive system audit and configuration correction
**Verified**: Both services running and communicating properly
